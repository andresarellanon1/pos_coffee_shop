<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="expense_report_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-set="lang" t-value="doc.operating_unit_id.partner_id.lang"/>
                <t t-call="tms.expense_report_body_template" t-lang="lang"/>
            </t>
        </t>
    </template>

    <template id="expense_report_body_template">
        <t t-call="tms.report_pdf_external_layout">
            <t t-set="doc" t-value="doc.with_context(lang=lang)"/>
            <div class="page">
                <div class="row">
                    <div class="text-center">
                        <span style="font-size: 15.5px; color: black; font-weight: bold">Expense: </span>
                        <span style="font-size: 15px; color: black" t-field="doc.name"/>
                    </div>
                </div>

                <div style="border: 1px solid black; margin-bottom: 20px">
                    <div class="row" style="margin-left: 10px">
                        <div class="col-6">
                            <span style="color: black; font-size: 15px; font-weight: bold">Driver: </span>
                            <span style="color: black; font-size: 13px; margin-left: 5px" t-field="doc.employee_id.employee_number"/>
                            <span style="color: black; font-size: 13px" t-field="doc.employee_id"/>
                        </div>
                        <div class="col-3">
                            <span style="color: black; font-size: 15px; font-weight: bold">Vat: </span>
                        </div>
                        <div class="col-3">
                            <span style="color: black; font-size: 15px; font-weight: bold">SSN: </span>
                            <span style="color: black; font-size: 13px; margin-left: 5px" t-field="doc.employee_id.ssnid"/>
                        </div>
                    </div>
                    <div class="row" style="margin-left: 10px">
                        <div class="col-3">
                            <span style="color: black; font-size: 15px; font-weight: bold">Date: </span>
                            <span style="color: black; font-size: 13px; margin-left: 5px" t-field="doc.date"/>
                        </div>
                        <div class="col-3">
                            <span style="color: black; font-size: 15px; font-weight: bold; padding: -5px">Departure: </span><br/>
                            <span style="color: black; font-size: 13px; margin-left: 5px" t-field="doc.start_date"/>
                        </div>
                        <div class="col-3">
                            <span style="color: black; font-size: 15px; font-weight: bold; padding: -5px">Arrival: </span><br/>
                            <span style="color: black; font-size: 13px; margin-left: 5px" t-field="doc.end_date"/>
                        </div>
                        <div class="col-3">
                            <span style="color: black; font-size: 15px; font-weight: bold">Days: </span>
                            <span style="color: black; font-size: 13px; margin-left: 5px" t-esc="doc._add_day()"/>
                        </div>
                    </div>
                    <div class="row" style="margin-left: 10px">
                        <div class="col-3">
                            <span style="color: black; font-size: 15px; font-weight: bold">Unit: </span>
                            <span style="color: black; font-size: 13px; margin-left: 5px" t-field="doc.unit_id"/>
                        </div>
                        <div class="col-6"/>
                        <div class="col-3">
                            <span style="color: black; font-size: 15px; font-weight: bold">Loaded Kms: </span>
                            <span style="color: black; font-size: 13px; margin-left: 5px" t-esc="sum(x.distance_route for x in doc.travel_ids)"/>
                            <br/><span style="color: black; font-size: 15px; font-weight: bold">Empty Kms: </span>
                            <span style="color: black; font-size: 13px; margin-left: 5px" t-esc="sum(x.distance_empty for x in doc.travel_ids)"/>
                            <br/><span style="color: black; font-size: 15px; font-weight: bold">Traveled Kms: </span>
                            <span style="color: black; font-size: 13px; margin-left: 5px" t-esc="int(doc.distance_real)"/><br/>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-5">
                        <span style="font-size: 15px; color: black; font-weight: bold">ITINERARY</span>

                        <div>
                            <ol>
                                <t t-as="travel" t-foreach="doc.travel_ids">
                                    <li style="color: black; font-size: 14px">
                                        <span t-field="travel.route_id"/>
                                    </li>
                                </t>
                            </ol>
                        </div>
                    </div>

                    <div class="col-7" style="text-transform: uppercase;">
                        <span style="font-size: 15px; color: black; font-weight: bold">TRAVEL EXPENSES</span>
                        <br/>

                        <div style="border: 0.5px solid black;"/>
                        <span style="font-size: 15px; color: black">Real Expenses:</span>
                        <br/>

                        <t t-foreach="doc.get_type_product()" t-as="product">
                            <t t-set="xml_file" t-value="product_value['xml_file']"/>

                            <t t-if="not xml_file">
                                <div class="row">
                                    <div class="col-10">
                                        <span t-esc="product_value['product_name']"/>
                                        <t t-if="'fuel' in product_value['line_type']">
                                            <span style="text-align: left; color: black; font-size: 13px" t-esc="product_value['product_qty']"/>
                                            <span style="color: black; font-size: 13px">lts</span>
                                        </t>
                                        <t t-if="'fuel_cash' in product_value['line_type']">
                                            <span style="text-align: left; color: black; font-size: 13px" t-esc="product_value['product_qty']"/>
                                            <span style="color: black; font-size: 13px">lts</span>
                                        </t>
                                    </div>
                                    <div class="col-2" style="text-align: right">
                                        <span style="color: black; font-size: 13px" t-esc="'%.2f' % product_value['subtotal']"/>
                                    </div>
                                </div>
                            </t>
                        </t>

                        <t t-foreach="doc.get_xml_data()" t-as="xml">
                            <t t-set="xml_file" t-value="xml_value['xml_file']"/>

                            <t t-if="xml_file">
                                <div class="row">
                                    <div class="col-10">
                                        <span style="color: black; font-size: 13px" t-esc="xml_value['product_name']"/>
                                    </div>
                                    <div class="col-2" style="text-align: right">
                                        <span style="color: black; font-size: 13px" t-esc="'%.2f' % xml_value['subtotal']"/>
                                    </div>
                                </div>
                            </t>
                        </t>
                        <br/>
                    </div>
                </div>

                <t t-set="other_income" t-value="doc.get_other_income()"/>
                <t t-set="tax_n_untax_amount" t-value="doc.get_untax_n_tax_amount()"/>

                <div class="row" style="margin-top: 20px">
                    <div class="col-5"/>
                    <div class="col-7" style="text-transform: uppercase;">
                        <span style="font-size: 15px; color: black; font-weight: bold">EXPENSES</span>

                        <div class="row">
                            <div class="col-10">
                                <span style="font-size: 12px; color: black; font-weight: bold">Driver salary:</span>
                            </div>
                            <div class="col-2" style="text-align: right">
                                <span style="color: black; font-size: 13px; text-align: right" t-esc="'%.2f' % doc.amount_salary"/>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-10">
                                <span style="font-size: 12px; color: black; font-weight: bold; text-align: right">Other income:</span>
                            </div>
                            <div class="col-2" style="text-align: right">
                                <t t-if="other_income == 0.0">
                                    <span style="text-align: right; color: black; font-size: 13px">0.00</span>
                                </t>
                                <t t-if="other_income != 0.0">
                                    <span/>
                                </t>
                            </div>
                        </div>

                        <t t-foreach="doc.get_other_income(with_name=True)" t-as="income">
                            <div class="row">
                                <div class="col-10">
                                    <span style="color: black; font-size: 11px" t-esc="income_value['name']"/>
                                </div>
                                <div class="col-2" style="text-align: right">
                                    <span style="color: black; font-size: 11px" t-esc="'%.2f' % income_value['price']"/>
                                </div>
                            </div>
                        </t>

                        <div class="row">
                            <div class="col-10">
                                <span style="font-size: 12px; color: black; font-weight: bold">Total expenses:</span>
                            </div>
                            <div class="col-2" style="text-align: right">
                                <span style="color: black; font-size: 13px" t-esc="'%.2f' % (tax_n_untax_amount['untax'] + other_income)"/>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-10">
                                <span style="font-size: 12px; color: black; font-weight: bold">Taxes expenses:</span>
                            </div>
                            <div class="col-2" style="text-align: right">
                                <span style="color: black; font-size: 13px" t-esc="'%.2f' % tax_n_untax_amount['tax']"/>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-10">
                                <span style="font-size: 12px; color: black; font-weight: bold">Total expenses with Taxes:</span>
                            </div>
                            <div class="col-2" style="text-align: right">
                                <span style="color: black; font-size: 13px" t-esc="'%.2f' % ((tax_n_untax_amount['untax'] + other_income) + tax_n_untax_amount['tax'])"/>
                            </div>
                        </div>
                    </div>
                </div>

                <br/>

                <table class="table table-borderless" style="margin-bottom: 20px">
                    <tr style="background-color: white; border-bottom: 1px solid; border-top: 1px solid">
                        <th style="color: black; font-size: 11.5px">No.</th>
                        <th style="color: black; font-size: 11.5px">Name</th>
                        <th style="text-align: center; color: black; font-size: 11.5px">Date</th>
                        <th style="color: black; font-size: 11.5px">No. Guide</th>
                        <th style="color: black; font-size: 11.5px">Trailer</th>
                        <th style="color: black; font-size: 11.5px">Weight</th>
                        <th style="color: black; font-size: 11.5px">Price</th>
                        <th style="color: black; font-size: 11.5px">Taxes</th>
                        <th style="color: black; font-size: 11.5px">Retentions</th>
                        <th style="color: black; font-size: 11.5px">Total</th>
                        <th style="color: black; font-size: 11.5px">Base</th>
                    </tr>

                    <t t-set="lines_and_totals" t-value="doc.get_travel_lines()"/>
                    <t t-set="ltotals" t-value="lines_and_totals['totals']"/>

                    <tr t-as="line" t-foreach="lines_and_totals['lines']" style="background-color: white; border-bottom: 1px solid; border-top: 1px solid">
                        <td>
                            <span style="color: black; font-size: 11px" t-esc="line_value['name']"/>
                        </td>
                        <td>
                            <span style="color: black; font-size: 11px" t-esc="line_value['partner_id']"/>
                        </td>
                        <td>
                            <span style="color: black; font-size: 11px" t-esc="line_value['date']"/>
                        </td>
                        <td>
                            <span style="color: black; font-size: 11px" t-esc="line_value['name']"/>
                        </td>
                        <td>
                            <span style="color: black; font-size: 11px" t-esc="line_value['trailer_id']"/>
                        </td>
                        <td>
                            <span style="color: black; font-size: 11px" t-esc="line_value['qty']"/>
                        </td>
                        <td>
                            <t t-if="line_value['subtotal_usd'] != 0.0">
                                <span style="color: black; font-size: 11px; font-weight: bold">USD:</span>
                                <span style="color: black; font-size: 11px" t-esc="line_value['subtotal_usd']"/>
                            </t>
                            <t t-if="line_value['tc'] != 0.0">
                                <span style="color: black; font-size: 11px; font-weight: bold">ER:</span>
                                <span style="color: black; font-size: 11px" t-esc="1 / line_value['tc']"/>
                            </t>
                            <t t-if="(line_value['tc'] != 0.0) or (line_value['subtotal_usd'] != 0.0)">
                                <span style="color: black; font-size: 11px; font-weight: bold">MXN:</span>
                            </t>
                            <span style="color: black; font-size: 11px" t-esc="'%.2f' % line_value['subtotal']"/>
                        </td>
                        <td>
                            <span style="color: black; font-size: 11px" t-esc="'%.2f' % line_value['tax_amount_iva']"/>
                        </td>
                        <td>
                            <span style="color: black; font-size: 11px" t-esc="'%.2f' % line_value['tax_amount_ret']"/>
                        </td>
                        <td>
                            <span style="color: black; font-size: 11px" t-esc="'%.2f' % line_value['total']"/>
                        </td>
                        <td>
                            <span style="color: black; font-size: 11px" t-esc="'%.2f' % line_value['base']"/>
                        </td>
                    </tr>

                    <tr style="text-align: left; background-color: white; ">
                        <td colspan="4"/>
                        <td>
                            <span style="color: black; font-size: 12px; text-align: right; font-weight: bold">
                                Total
                            </span>
                        </td>
                        <td>
                            <span style="color: black; font-size: 12px" t-esc="ltotals['qty']"/>
                        </td>
                        <td>
                            <span style="color: black; font-size: 12px" t-esc="'%.2f' % ltotals['subtotal']"/>
                        </td>
                        <td>
                            <span style="color: black; font-size: 12px" t-esc="'%.2f' % ltotals['tax_amount_iva']"/>
                        </td>
                        <td>
                            <span style="color: black; font-size: 12px" t-esc="'%.2f' % ltotals['tax_amount_ret']"/>
                        </td>
                        <td>
                            <span style="color: black; font-size: 12px" t-esc="'%.2f' % (ltotals['subtotal'] + ltotals['rc'] + ltotals['tax_amount_iva'] + ltotals['tax_amount_ret'])"/>
                        </td>
                        <td>
                            <span style="color: black; font-size: 12px" t-esc="'%.2f' % ltotals['base']"/>
                        </td>
                    </tr>
                </table>

                <div class="container row">
                    <div class="col-6" style="margin-right: 30px">
                        <div class="text-center" style="font-size: 15px; color: black; margin-bottom: 5px">EXPENSE SUMMARY</div>
                        <div class="row" style="margin-bottom: 15px">
                            <div class="col-6">
                                <span style="font-size: 16px; color: black; font-weight: bold">Salary</span>
                            </div>
                            <div class="col-6" style="text-align: right">
                                <span style="color: black; font-size: 15px" t-options="{&quot;widget&quot;: &quot;monetary&quot;}" t-field="doc.amount_salary"/>
                            </div>
                        </div>

                        <div class="list-group" style="margin-bottom: 15px">
                            <h5 class="list-group-item-heading">
                                <span style="font-size: 16px; color: black; font-weight: bold">Salary Discounts</span>
                            </h5>
                            <div class="list-group-item-text" style="font-size: 12px;">
                                <t t-as="discount" t-foreach="doc.expense_line_ids">
                                    <t t-set="line" t-value="discount.line_type"/>
                                    <t t-if="(line == 'salary_discount') and (discount.product_id.default_code not in ['38', '71', '73'])">
                                        <div class="row">
                                            <div class="col-9">
                                                <span style="font-size: 13px; color: black" t-esc="discount.name"/>
                                            </div>
                                            <div class="col-3" style="text-align: right">
                                                <span style="font-size: 13px; color: black" t-esc="discount.price_total"/>
                                            </div>
                                        </div>
                                    </t>
                                </t>
                            </div>
                        </div>

                        <div class="list-group" style="margin-bottom: 15px">
                            <h5 class="list-group-item-heading">
                                <span style="font-size: 16px; color: black; font-weight: bold">Salary Retentions</span>
                            </h5>
                            <div class="list-group-item-text" style="font-size: 11px; margin-left: 15px">
                                <t t-as="discount" t-foreach="doc.expense_line_ids">
                                    <t t-set="line" t-value="discount.line_type"/>
                                    <t t-if="line == 'salary_retention'">
                                        <div class="row">
                                            <div class="col-9">
                                                <span style="font-size: 13px; color: black" t-esc="discount.name"/>
                                            </div>
                                            <div class="col-3" style="text-align: right">
                                                <span style="font-size: 13px; color: black" t-esc="discount.price_total"/>
                                            </div>
                                        </div>
                                    </t>
                                </t>
                            </div>
                        </div>

                        <div class="row" style="margin-bottom: 15px">
                            <div class="col-6">
                                <span style="font-size: 16px; color: black; font-weight: bold">ISPT</span>
                            </div>
                            <div class="col-6" style="text-align: right">
                                <span style="color: black; font-size: 15px" t-esc="doc.get_amount_ispt()"/>
                            </div>
                        </div>

                        <div class="list-group" style="margin-bottom: 15px">
                            <h5 class="list-group-item-heading">
                                <span style="font-size: 16px; color: black; font-weight: bold">Expenses</span>
                            </h5>
                            <div class="list-group-item-text" style="font-size: 11px;">
                                <t t-as="discount" t-foreach="doc.expense_line_ids">
                                    <t t-set="line" t-value="discount.line_type"/>
                                    <t t-if="(line == 'loan') and (discount.product_id.default_code not in ['38', '71', '73'])">
                                        <div class="row">
                                            <div class="col-9">
                                                <span style="font-size: 13px; color: black" t-esc="discount.product_id.name"/>
                                            </div>
                                            <div class="col-3" style="text-align: right">
                                                <span style="font-size: 13px; color: black" t-esc="discount.price_total"/>
                                            </div>
                                        </div>
                                    </t>
                                </t>
                            </div>
                        </div>

                        <div class="row" style="margin-bottom: 15px">
                            <div class="col-6">
                                <span style="font-size: 16px; color: black; font-weight: bold">Per Diem</span>
                            </div>
                            <div class="col-6" style="text-align: right">
                                <span style="color: black; font-size: 15px" t-esc="doc.get_expense()"/>
                            </div>
                        </div>

                        <div class="list-group" style="margin-bottom: 15px">
                            <h5 class="list-group-item-heading">
                                <span style="font-size: 16px; color: black; font-weight: bold">Advances</span>
                            </h5>
                            <div class="list-group-item-text" style="font-size: 11px">
                                <t t-as="advance" t-foreach="doc.advance_ids">
                                    <div class="row">
                                        <div class="col-9">
                                            <span style="font-size: 13px; color: black" t-field="advance.name"/>
                                        </div>
                                        <div class="col-3" style="text-align: right">
                                            <span style="font-size: 13px; color: black" t-esc="advance.amount"/>
                                        </div>
                                    </div>
                                </t>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-6"/>
                            <div class="col-6 text-center">
                                <hr/>
                                <span style="font-size: 13px; color: black">SALARY</span><br/>
                                <span style="font-size: 13px; color: black; text-align: right; margin-left: 80px;" t-options="{&quot;widget&quot;: &quot;monetary&quot;}" t-field="doc.amount_balance"/>
                            </div>
                        </div>
                    </div>

                    <div class="col-6">
                        <div class="list-group" style="margin-bottom: 15px">
                            <div class="list-group-item-text">
                                <div class="row">
                                    <div class="col-6">
                                        <span class="text-center" style="font-size: 15px; color: black">STATISTICAL DATA</span><br/>
                                        <div style="font-size: 12px; color: black">
                                            <span style="margin-right: 10px">KMS/LT. Unity:</span>
                                            <span t-esc="'%.2f' % doc.fuel_efficiency"/>
                                            <br/><span style="margin-right: 15px">Income by km:</span>
                                            <t t-if="doc.distance_real">
                                                <t t-set="income" t-value="ltotals['subtotal'] /doc.distance_real"/>
                                                <span style="text-align: right;" t-esc="'%.2f' % income"/>
                                            </t>
                                            <t t-if="not doc.distance_real">
                                                <span>0.0</span>
                                            </t>
                                            <br/><span style="margin-right: 30px">Cost by km:</span>
                                            <t t-if="doc.distance_real">
                                                <t t-set="cost" t-value="(doc.amount_salary + tax_n_untax_amount['untax'] + other_income) / doc.distance_real or 0.0"/>
                                                <span style="text-align: right;" t-esc="'%.2f' % cost"/>
                                            </t>
                                            <t t-if="not doc.distance_real">
                                                <span>0.0</span>
                                            </t>
                                            <br/><span style="margin-right: 20px">Productivity:</span>
                                            <t t-if="ltotals['subtotal']">
                                                <t t-set="productivity" t-value="((doc.amount_salary + tax_n_untax_amount['untax'] + other_income) * 100 / ltotals['subtotal'])"/>
                                                <span style="text-align: right;" t-esc="'%.2f' % productivity"/>
                                                <span>%</span>
                                            </t>
                                            <t t-if="not ltotals['subtotal']">
                                                <span>0.0</span>
                                            </t>
                                        </div>
                                    </div>

                                    <div class="col-6">
                                        <span class="text-center" style="font-size: 15px; color: black">UNIT PERFORMANCE</span><br/>
                                        <span style="text-align: right; font-size: 13px; color: black" t-field="doc.fuel_efficiency"/>
                                        <br/>
                                        <br/>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="list-group" style="margin-bottom: 60px">
                            <h5 class="list-group-item-heading">
                                <span style="font-size: 16px; color: black; font-weight: bold">Notes:</span>
                            </h5>
                            <div class="list-group-item-text">
                                <span style="margin-left: 30px; font-size: 11px" t-esc="doc.notes"/>
                            </div>
                        </div>

                        <div class="list-group">
                            <div class="list-group-item-text">
                                <div class="row">
                                    <div class="col-6 text-center">
                                        <hr style="width: 85%"/>
                                        <span style="color: black; font-size: 14px">Driver</span>
                                    </div>
                                    <div class="col-6 text-center">
                                        <hr style="width: 85%"/>
                                        <span style="color: black; font-size: 14px">Reviewed by</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <t t-set="Panel_Header" t-value="'color:#000000; text-align:left;font-size:10px;background-color:#f0f0f0;border-color: #333; padding-left:5; padding-right:0; padding-top:5; padding-bottom:0;'"/>
        </t>
    </template>
</odoo>
